# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных:

-Интерфейс для данных каточки товара (в таком виде данные приходят с сервера).

```
interface ICard {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number; 
}
```

-Интерфейс для модели данных карточек(товаров).

```
interface ICardsData {
  cards: ICard[];
  getCard(id: string): ICard | undefined;
}
```

-Интерфейс для модели данных корзины.

```
interface IBasketModel {
  add(item: ICard): void;
  remove(id: string): void;
  clear(): void;
  getTotal(): number;
  getTotalPrice(): number;
  getIds(): string[];
  isEmpty(): boolean;
  contains(id: string): boolean;
  items: ICard[]; // добавлен геттер для items
}
```

-Тип данных метода оплаты.

```
type TPaymentMethod = 'online' | 'cash';
```

-Интерфейс для модели данных заказа.

```
interface IOrderDetails {
  payment: TPaymentMethod;
  email: string;
  phone: string;
  address: string;
}
```

-Интерфейс для отображения главной страницы.

```
interface IPage {
	counter: number;
	catalog: HTMLElement[];
	basket: HTMLElement;
	locked: boolean;
}
```

-Интерфейс для отображения модалки.

```
interface IModal {
	content: HTMLElement;
	closeButton: HTMLButtonElement;
	open(): void;
	close(): void;
}
```

-Интерфейс для отображения карточки.

```
interface ICardView {
  render(data: ICard, index?: number): HTMLElement;
}
```

-Интерфейс для отображения корзины.

```
interface IBasketView {
  render(data: { items: HTMLElement[]; price: number; isEmpty: boolean }): HTMLElement;
}
```

-Интерфейс для отображения форм.

```
export interface IFormView {
  render(): HTMLElement;
}
```

-Интерфейс для отображения успешного заказа.

```
export interface ISuccess {
  render(total: number): HTMLElement;
}
```

## Архитектура приложения
Код приложения разделен на слои согласно парадигме MVP:
- слой данных(Model), отвечает за хранение и изменение данных.
- слой представления(View), отвечает за отображение данных на странице.
- презентер(Presenter), отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.

Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс LarekApi
Наследует класс Api и отвечает за работу апи непосредственно нашего приложения.

Методы:
- getCards(): Promise<ApiListResponse<ICard>> - запрашивает и возвращает с сервера массив товаров в формате ICard и их количество.
- createOrder(order: {payment: string, email: string, phone: string, address: string, total: number, items: string[]}): Promise<object> - отправляет на сервер заказ (объект в формате в котором сервер принимает заказ)

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий. 

Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие    

### Слой данных

#### Класс CardsData
Реализует интерфейс ICardsData.
Отвечает за хранение и логику работы с данными карточек(товаров) загруженных с сервера.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:
- private _cards: ICard[] - массив объектов карточек.
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Методы:
- getCard(id: string): ICard - возвращает карточку по ее id
- get cards(): ICard[] - возвращает массив карточек _cards
- set cards(cards: ICard[]) - устанавливает массив карточек _cards и вызывает событие 'cards:updated' передавая массив карточек

#### Класс BasketModel
Реализует интерфейс IBasketModel.
Класс отвечает за хранение и логику работы с товарами в корзине.
Конструктор класса принимает инстанс брокера событий.

В полях класса хранятся следующие данные:

- private _items: ICard[] - хранит товары, добавленные в корзину.
- events: IEvents - экземпляр класса EventEmitter для инициации событий при изменении данных.

Методы:

- add(item: ICard): void - Добавляет товар в корзину, если товар с таким же id отсутствует. Вызывает _changed() для уведомления об изменении корзины.
- remove(id: string): void - Удаляет товар из корзины по его id. Вызывает _changed() для уведомления об изменении корзины.
- clear(): void - Удаляет все товары из корзины. Вызывает _changed() для уведомления об изменении корзины.
- getTotal(): number - Возвращает количество товаров в корзине.
- getTotalPrice(): number - Возвращает общую стоимость товаров в корзине.
- getIds(): string[] - Возвращает массив с id товаров, находящихся в корзине.
- contains(id: string): boolean - Проверяет, содержится ли товар с указанным id в корзине.
- get items(): ICard[] - Возвращает массив текущих товаров в корзине.
- isEmpty(): boolean - Проверяет, пуста ли корзина.
- private _changed(): void - Защищенный метод, который инициирует событие 'basket:changed', передавая текущие товары корзины.

#### Класс OrderDetails
Класс отвечает за хранение и заполнение, объекта с данными заказа (только данные клиента, список товаров и сумма заказа будут браться из модели корзины).

В полях класса хранятся следующие данные:
- private _orderDetails: IOrderDetails; - Хранит даные заказа.
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Методы:
- set payment(payment: TPaymentMethod) - Вызывает свой валидатор. Устанавливает способ оплаты. 
- set email(email: string) - Вызывает свой валидатор. Устанавливает адрес доставки.
- set phone(phone: string) - Вызывает свой валидатор. Устанавливает телефон.
- set address(address: string) - Вызывает свой валидатор. Устанавливает адрес доставки.
- get order(): IOrderDetails - Возвращает данные заказа.

- private validatePayment(payment: TPaymentMethod): void - валидатор способа оплаты.
- private validateEmail(email: string): void - валидатор email.
- private validatePhone(phone: string): void - валидатор телефона.
- private validateAddress(address: string): void - валидатор адреса.

### Слой отображения

#### Класс PageView
Отображение главной страницы. Реализует интерфейс IPage.
Конструктор класса принимает инстант брокера событий и (container: HTMLElement) для определения в нем нужных элементов.
На элемент корзины устанавливается обработчик клика вызывающий событие 'basket:open'.

В полях класса хранятся следующие данные:
- _counter: HTMLElement - количество товаров в корзине.
- _catalog: HTMLElement - каталог товаров.
- _wrapper: HTMLElement - обертка страницы (для блокировки прокрутки при открытом попапе).
- _basket: HTMLElement - элемент корзины.
- events: IEvents - экземпляр, реализующий интерфейс IEvents, используемый для управления событиями страницы.

Методы:
- set counter(value: number) - Устанавливает значение счетчика корзины.
- set catalog(items: HTMLElement[]) - Устанавливает каталог товаров, заменяя текущее содержимое элемента _catalog на новый массив.
- set locked(value: boolean) - Блокирует страницу, добавляя или удаляя класс page__wrapper_locked из элемента _wrapper.

#### Класс ModalView
Реализует интерфейс IModal.
Класс отвечает за управление модальным окном, включая его открытие и закрытие, а также обработку событий.

Конструктор класса принимает инстанс брокера событий и контейнер модального окна.

В полях класса хранятся следующие данные:

- private _content: HTMLElement - элемент, содержащий контент модального окна.
- private _container: HTMLElement - контейнер, в котором находится модальное окно.
- closeButton: HTMLButtonElement - кнопка для закрытия модального окна.
- events: IEvents - экземпляр класса EventEmitter для инициации событий при изменении состояния модального окна.

Методы:

- set content(value: HTMLElement): void - Устанавливает контент модального окна. Заменяет текущий контент на новый.
- open(): void - Открывает модальное окно. Добавляет CSS класс 'modal_active' к контейнеру и вызывает emitOpenEvent() для уведомления об открытии.
- close(): void - Закрывает модальное окно. Удаляет CSS класс 'modal_active' из контейнера, очищает контент и вызывает emitCloseEvent() для уведомления о закрытии.
- private onContainerClick(event: MouseEvent): void - Обработчик событий клика на контейнере. Закрывает модальное окно, если клик произошел вне области контента.
- private emitCloseEvent(): void - Инициирует событие 'modal:close'.
- private emitOpenEvent(): void - Инициирует событие 'modal:open'.

#### Класс CardView
Реализует интерфейс ICardView.
Класс отвечает за создание и базовую настройку элементов карточек.
Конструктор класса принимает экземпляр EventEmitter для обработки событий и HTMLTemplateElement для клонирования шаблона.

В полях класса хранятся следующие данные:

- protected events: EventEmitter - экземпляр класса EventEmitter для инициации событий.
- private template: HTMLTemplateElement - шаблон для клонирования HTML-элементов карточки.

Методы:

- protected createElement(): HTMLElement - создает и возвращает элемент карточки, клонируя содержимое шаблона.
- protected setCategoryClass(element: HTMLElement, category: string): void - устанавливает CSS-класс для элемента в зависимости от категории.
- protected populateCard(element: HTMLElement, data: ICard): void - заполняет элемент карточки данными (категория, название, изображение, цена).
- abstract render(data: ICard, index?: number): HTMLElement - абстрактный метод, который должен быть реализован в наследуемых классах для отрисовки карточки.

#### Класс GalleryCardView
Наследуется от CardView.
Класс отвечает за отрисовку карточек в галерее.

Методы:

- render(data: ICard): HTMLElement - переопределяет метод из CardView, заполняя элемент данными карточки и добавляя обработчик события клика, который инициирует событие 'item:selected'.

#### Класс CardPreviewView
Наследуется от CardView.
Класс отвечает за отрисовку превью карточек.

Методы:

- render(data: ICard): HTMLElement - переопределяет метод из CardView, заполняя элемент данными карточки, добавляет описание, кнопку и устанавливает обработчик события клика на кнопку, который инициирует событие 'basket:add'.

#### Класс CardBasketView
Наследуется от CardView.
Класс отвечает за отрисовку карточек товаров в корзине.

Методы:

- render(data: ICard, index: number): HTMLElement - переопределяет метод из CardView, заполняя элемент данными карточки и добавляя индекс элемента в корзине. Устанавливает обработчик события клика на кнопку, который инициирует событие 'item:delete'.

#### Класс BasketView
Реализует интерфейс IBasketView.
Класс отвечает за отображение содержимого корзины и управление элементами пользовательского интерфейса.
Конструктор класса принимает инстант брокера событий и шаблон HTMLTemplateElement.

В полях класса хранятся следующие данные:

- events: IEvents - экземпляр класса EventEmitter для управления событиями пользовательского интерфейса.
- productsList: HTMLUListElement - элемент списка для отображения товаров в корзине.
- totalPrice: HTMLSpanElement - элемент для отображения общей стоимости товаров в корзине.
- submitOrder: HTMLButtonElement - кнопка для оформления заказа.
- basketElement: HTMLElement - корневой элемент корзины.

Методы:

- render(data: { items: HTMLElement[]; price: number; isEmpty: boolean }): HTMLElement - Отображает товары в корзине, обновляет общую стоимость и состояние кнопки оформления заказа.
Очищает текущий список товаров.
Добавляет новые товары в список.
Обновляет текстовое содержание элемента общей стоимости.
Включает или отключает кнопку оформления заказа в зависимости от наличия товаров в корзине.
Возвращает обновленный элемент корзины.

#### Класс Form
Реализует интерфейс IFormView.
Класс отвечает за создание и отображение элементов формы, а также за управление ошибками отображения.
Конструктор класса принимает экземпляр брокера событий и шаблон.

В полях класса хранятся следующие данные:

- protected events: EventEmitter - Экземпляр класса EventEmitter для инициации событий при изменении данных.
- protected template: HTMLTemplateElement - шаблон для создания элемента формы.

Методы:

- render(): HTMLElement - Абстрактный метод, который должен быть реализован в классах-наследниках и возвращать готовый элемент формы.
- protected createElement(): HTMLElement - Создает и возвращает элемент на основе переданного шаблона.
- protected showError(element: HTMLElement, message: string): void - Отображает сообщение об ошибке в переданном элементе формы.
- protected clearError(element: HTMLElement): void - Очищает сообщение об ошибке в переданном элементе формы.

#### Класс PaymentView
Наследуется от класса Form.
Класс отвечает за отображение и валидацию формы оплаты.
Конструктор класса принимает экземпляр брокера событий и шаблон.

Методы:

- render(): HTMLElement - Создает и возвращает элемент формы оплаты, добавляет обработчики событий для элементов формы.
- private validateForm(): void - Проверяет заполненность полей формы и устанавливает состояние кнопки отправки формы.
- private showError(element: HTMLElement, message: string): void - Отображает сообщение об ошибке в переданном элементе формы.
- private clearError(element: HTMLElement): void - Очищает сообщение об ошибке в переданном элементе формы.

#### Класс ContactsView
Наследуется от класса Form.
Класс отвечает за отображение и валидацию формы контактов.
Конструктор класса принимает экземпляр брокера событий и HTML-шаблон.

Методы:

- render(): HTMLElement - Создает и возвращает элемент формы контактов, добавляет обработчики событий для элементов формы.
- private validateForm(): void - Проверяет заполненность полей формы и устанавливает состояние кнопки отправки формы.
- private showError(element: HTMLElement, message: string): void - Отображает сообщение об ошибке в переданном элементе формы.
- private clearError(element: HTMLElement): void - Очищает сообщение об ошибке в переданном элементе формы.

#### Класс Success
Отображение сообщения об успешной оплате.
Конструктор класса принимает инстант брокера событий и (container: HTMLElement) для определения в нем нужных элементов.
На кнопку за новыми покупками уснанавливается слушатель клика инициирующий событие ('order:submited').

В полях класса хранятся следующие данные:
- private events: EventEmitter - экземпляр, реализующий интерфейс IEvents, используемый для управления событиями.
- private priceElement: HTMLElement - списанная сумма
- private closeButton: HTMLButtonElement - кнопка за новыми покупками
- private element: HTMLElement - контейнер элемента
- private template: HTMLTemplateElement - шаблон для клонирования элементов карточки

Методы:
- render(price: number): HTMLElement - возвращает готовый элемент.

### Презентер
Модели и отображение будут связываться с использованием событийно-ориентированного подхода, сам код презентера не будет выделен в отдельный класс, а будет размещен в основном скрипте приложения index.ts.
Далее описан сценарий работы приложения и применяемые события:

- При загрузке сайта:
-Создаются экземпляры классов: LarekApi, EventEmitter, CardsData, BasketModel, OrderDetails, PageView, ModalView.
-С сервера запрашивается список товаров и сохраняется в модель CardsData в следствии чего вызывается событие 'cards:updated' передавая массив карточек, на основании переданного массива создается массив элементов карточек товара (СatalogCardVeiw) и вставляется в список товаров внутри (PageView).

- Нажатие на карточку товара в каталоге (СatalogCardVeiw) вызывает событие 'product:selected' передавая данные товара. С использованием этих данных (CardPreviewVeiw) отрисовывает элемент предпросмотра товара и вставляется в мадалку (ModalView), после чего, модалка отображается на экране.

- Нажатие на кнопку добавления в корзину вызывает событие 'product:add' передавая данные товара. Данные сохраняются в модель корзины (BasketModel). Модальное окно закрывается.

- При вызове функций добавления товара и удаления товара вызывается событие 'basket:changed' передавая id соответствующего товара. Реакцией на это событие является: Соответствующее изменение в модели данных корзины (BasketModel), перерисовка отображения корзины (BasketView) и обнавление счетчика товаров в корзине на главной странице.

- Нажатие на корзину вызывает событие 'basket:open'. Используя данные и методы модели корзины отрисовывается элемент корзины (BasketView), отрисовываются элементы корзины (BasketItemView), вставляются в корзину, после чего, корзина вставляется в модалку и отображается на экране.

- Нажатие на кнопку удаления товара из корзины вызывает событие 'basket:changed' описанное выше.

- Нажатие на кнопку оформления заказа вызывает событие 'goto:payment'. Отрисовывается элемент выбора метода оплаты (PaymentView) и вставляется в модалку.

- Нажатие на кнопку далее вызывает событие 'goto:email' передавая способ оплаты и адрес. Эти данные сохраняются в модель зказа (OrderDetails). Отрисовывается элемент ввода почты и телефона (ContactsView) и вставляется в модалку.

- Нажатие на кнопку оплатить вызывает событие 'submit:order' передавая почту и телефон. Эти данные сохраняются в модель зказа (OrderDetails). После чего, в методе отправки заказа на сервер (LarekApi) собирается объект с данными заказа. Они берутся из модели (OrderDetails) и модели корзины (BasketModel). Заказ отравляется на сервер. Корзина очищается. Отрисовывается сообщения об успешной оплате (Success) и вставляется в модалку.

- Нажатие на кнопку за новыми покупками вызывает событие 'order:submited'. Модальное окно закрывается. 