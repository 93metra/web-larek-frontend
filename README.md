# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных:

-Интерфейс для данных каточки товара (в таком виде данные приходят с сервера).

```
interface ICard {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number; 
}
```

-Интерфейс для модели данных карточек(товаров).

```
interface ICardsData {
  cards: ICard[];
  getCard(id: string): ICard;
}
```

-Интерфейс для модели данных корзины.

```
interface IBasketModel {
  add(item: ICard): void;
  remove(id: string): void;
  clear(): void;
  getTotal(): number;
  getTotalPrice(): number;
  getIds(): string[];
}
```

-Тип данных метода оплаты.

```
type TPaymentMethod = 'online' | 'cash';
```

-Интерфейс для модели данных заказа.

```
interface IOrderDetails {
  payment: TPaymentMethod;
  email: string;
  phone: string;
  address: string;
}
```

-Интерфейс для отображения главной страницы.

```
interface IPage {
	counter: number;
	catalog: HTMLElement[];
	basket: HTMLElement;
	locked: boolean;
}
```

-Интерфейс для отображения модалки.

```
interface IModal {
	content: HTMLElement;
	closeButton: HTMLButtonElement;
}
```

-Базовый интерфейс отображения элементов внутри модалки.

```
interface IView {
  render(template: HTMLTemplateElement): HTMLElement;
}
```

-Тип данных шаблона карточки товара.

```
type TemplateType = 'catalog' | 'preview' | 'basket';
```

## Архитектура приложения
Код приложения разделен на слои согласно парадигме MVP:
- слой данных(Model), отвечает за хранение и изменение данных.
- слой представления(View), отвечает за отображение данных на странице.
- презентер(Presenter), отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.

Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс LarekApi
Наследует класс Api и отвечает за работу апи непосредственно нашего приложения.

Методы:
- getCards(): Promise<ApiListResponse<ICard>> - запрашивает и возвращает с сервера массив товаров в формате ICard и их количество.
- createOrder(orderDetails: IOrderDetails): Promise<object> - отправляет на сервер заказ (объект в формате IOrderDetails)

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий. 

Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие    

### Слой данных

#### Класс CardsData
Реализует интерфейс ICardsData.
Отвечает за хранение и логику работы с данными карточек(товаров) загруженных с сервера.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:
- private _cards: ICard[] - массив объектов карточек.
- public events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Методы:
- public getCard(id: string): ICard - возвращает карточку по ее id
- public get cards(): ICard[] - возвращает массив карточек _cards
- public set cards(cards: ICard[]) - устанавливает массив карточек _cards и вызывает событие 'cards:updated' передавая массив карточек

#### Класс BasketModel
Реализует интерфейс IBasketModel.
Класс отвечает за хранение и логику работы с товарами в корзине.
Конструктор класса принимает инстант брокера событий.

В полях класса хранятся следующие данные:
- private items: ICard[] - Хранит товары и их порядковые номера.
- public events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Методы:
- public add(item: ICard): void - Добавляет товар в корзину и присваивает ему порядковый номер.
Вызывает _changed() для уведомления об изменении корзины.
- public remove(id: string): void - Удаляет товар из корзины.
Вызывает _changed() для уведомления об изменении корзины.
- public clear(): void - удаляет все товары из корзины.
Вызывает _changed() для уведомления об изменении корзины.
- public getTotal(): number - Возвращает количество товаров в корзине.
- public getTotalPrice(): number - Возвращает общую цену.
- public getIds(): string[] - возвращает массив с айди товаров, для передачи в модель заказа.
- private _changed(): void - Защищенный метод, который инициирует событие 'basket:changed', передавая текущие товары корзины.

#### Класс OrderDetails
Класс отвечает за хранение и заполнение, объекта с данными заказа (только данные клиента, список товаров и сумма заказа будут браться из модели корзины).

В полях класса хранятся следующие данные:
- private _orderDetails: IOrderDetails; - Хранит даные заказа.
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Методы:
- public set payment(payment: TPaymentMethod) - Вызывает свой валидатор. Устанавливает способ оплаты. 
- public set email(email: string) - Вызывает свой валидатор. Устанавливает адрес доставки.
- public set phone(phone: string) - Вызывает свой валидатор. Устанавливает телефон.
- public set address(address: string) - Вызывает свой валидатор. Устанавливает адрес доставки.
- public get order(): IOrderDetails - Возвращает данные заказа.

- private validatePayment(payment: TPaymentMethod): void - валидатор способа оплаты.
- private validateEmail(email: string): void - валидатор email.
- private validatePhone(phone: string): void - валидатор телефона.
- private validateAddress(address: string): void - валидатор адреса.

### Слой отображения

#### Класс PageView
Отображение главной страницы. Реализует интерфейс IPage.
Конструктор класса принимает инстант брокера событий и (container: HTMLElement) для определения в нем нужных элементов.
На элемент корзины устанавливается обработчик клика вызывающий событие 'basket:open'.

В полях класса хранятся следующие данные:
- _counter: HTMLElement - количество товаров в корзине.
- _gallery: HTMLElement - каталог товаров.
- _wrapper: HTMLElement - обертка страницы (для блокировки прокрутки при открытом попапе).
- _basket: HTMLElement - элемент корзины.
- events: IEvents - экземпляр, реализующий интерфейс IEvents, используемый для управления событиями страницы.

Методы:
- set counter(value: number) - Устанавливает значение счетчика корзины.
- set catalog(items: HTMLElement[]) - Устанавливает каталог товаров, заменяя текущее содержимое элемента _gallery на новый массив.
- set locked(value: boolean) - Блокирует страницу, добавляя или удаляя класс page__wrapper_locked из элемента _wrapper.

#### Класс ModalView
Единое модальное окно в которое вставляется любое необходимое содержимое.
Реализует интерфейс IModal.
Конструктор класса принимает инстант брокера событий и (container: HTMLElement) для определения в нем нужных элементов.

В полях класса хранятся следующие данные:
- _closeButton: HTMLButtonElement - кнопка закрытия модального окна
- _content: HTMLElement - контейнер для содержимого модального окна
- events: IEvents - Экземпляр, реализующий интерфейс IEvents, используемый для управления событиями модального окна

Методы:
- set content(value: HTMLElement) - Устанавливает новое содержимое модального окна, заменяя текущее содержимое.
- open() - Добавляет класс modal_active к контейнеру, чтобы показать модальное окно.
- close() - Удаляет класс modal_active из контейнера, чтобы скрыть модальное окно.
Очищает содержимое модального окна.

#### Класс CardView
Отображение карточки в любом виде (В каталоге / модалке превью / корзине). 
Реализует интерфейс IView.
Конструктор класса принимает инстант брокера событий.

В полях класса хранятся следующие данные:
- events: IEvents - экземпляр, реализующий интерфейс IEvents, используемый для управления событиями страницы.

Методы:
- public render(data: ICard, templateType: TemplateType, container: HTMLElement): HTMLElement - возвращает готовый элемент. (находит в разметке нужный элемент шаблона).
-  private updateCardElement(cardElement: HTMLElement, data: ICard, templateType: TemplateType): void - вызывается внутри метода render. Заполняет разметку в зависимости от типа шаблона.
- private attachEventListeners(cardElement: HTMLElement, data: ICard, templateType: TemplateType): void - вызывается внутри метода render. Добавляет слушатели событий в зависимости от типа шаблона. 

В зависимости от шаблона нажатие на кнопку вызывает следуюшие события:
- 'catalog'(карточка товара в каталоге): 'product:selected' + передает данные карточки
- 'preview'(предпросмотр карточки): 'product:add' + передает данные карточки
- 'basket'(карточка в корзине): 'product:remove' + передает id товара


#### Класс BasketView
Отображение корзины. Реализует интерфейс IView.
Конструктор класса принимает инстант брокера событий и (container: HTMLElement) для определения в нем нужных элементов.
На кнопку оформления заказа уснанавливается слушатель клика инициирующий событие ('goto:payment').

В полях класса хранятся следующие данные:
- events: IEvents - экземпляр, реализующий интерфейс IEvents, используемый для управления событиями страницы.
- productsList: HTMLUListElement - список товаров.
- totalPrice: HTMLSpanElement - общая цена заказа.
- submitOrder: HTMLButtonElement - Кнопка оформления заказа.

Методы:
- render(data: {items: HTMLElement[], price: number}): HTMLElement - заполняет разметку и возвращает готовый элемент.

#### Класс Класс FormView
Базовый класс для создания форм с поддержкой событий и валидации. Предоставляет методы для работы с элементами формы и обработчиками событий. 
Конструктор класса принимает инстанс брокера событий (events: IEvents) и контейнер (container: HTMLElement) для размещения формы.

В полях класса хранятся следующие данные:
- protected events: IEvents - экземпляр, реализующий интерфейс IEvents, используемый для управления событиями страницы.
- protected container: HTMLElement - контейнер, в котором будет размещена форма.
- protected form: HTMLFormElement - элемент формы.
- protected submitButton: HTMLButtonElement - кнопка отправки формы.
- protected errorsElement: HTMLElement - элемент для отображения ошибок формы.

Методы:
- protected getInputValues(): { [key: string]: string } - возвращает значения всех полей ввода в форме.
- protected validate(): boolean - выполняет валидацию формы. Возвращает true, если форма валидна.
- protected handleSubmit(event: Event): void - обработчик события отправки формы. Предотвращает стандартное поведение и вызывает метод emitEvent(), если форма валидна, иначе показывает сообщение об ошибке.
- protected emitEvent(): void - метод для генерации события. Реализуется в дочерних классах.
- render(template: HTMLTemplateElement): HTMLElement - возвращает готовый элемент формы. Реализуется в дочерних классах.

#### Класс PymentMethodView (наследует класс FormView)
Отображение окна с выбором метода оплаты и введением адреса доставки.
Конструктор класса принимает инстанс брокера событий (events: IEvents) и контейнер (container: HTMLElement) для размещения формы.
На кнопку далее уснанавливается слушатель клика инициирующий событие ('goto:email') передавая способ оплаты и адрес.

В полях класса хранятся следующие данные:
- events: IEvents - экземпляр, реализующий интерфейс IEvents, используемый для управления событиями страницы.
- private addressInput: HTMLInputElement - поле ввода адреса доставки.
- private onlineButton: HTMLButtonElement - кнопка выбора оплаты онлайн.
- private cashButton: HTMLButtonElement - кнопка выбора оплаты при получении.
- private submitButton: HTMLButtonElement - кнопка "далее".
- private paymentMethod: TPaymentMethod - выбранный метод оплаты.

Методы:
- protected setupElements(): void - находит и инициализирует элементы формы.
- protected setupListeners(): void - устанавливает обработчики событий для кнопок и полей ввода.
- private selectPaymentMethod(method: TPaymentMethod): void - выбирает метод оплаты и обновляет состояние кнопки отправки формы.
- private handleInput(): void - обработчик ввода в поле адреса. Обновляет состояние кнопки отправки формы.
- private updateSubmitButtonState(): void - обновляет состояние кнопки отправки формы в зависимости от введенного адреса и выбранного метода оплаты.
- protected emitEvent(): void - инициирует событие 'goto:email', передавая выбранный метод оплаты и введенный адрес.
- render(template: HTMLTemplateElement): HTMLElement - возвращает готовый элемент формы.

#### Класс EmailVeiw (наследует класс FormView)
Отображение формы для ввода контактной информации, включая email и телефон.
Конструктор класса принимает инстанс брокера событий (events: IEvents) и контейнер (container: HTMLElement) для размещения формы.
На кнопку отправки формы уснанавливается слушатель клика инициирующий событие ('submit:order') передавая почту и телефон.

В полях класса хранятся следующие данные:
- events: IEvents - экземпляр, реализующий интерфейс IEvents, используемый для управления событиями страницы.
-  private emailInput: HTMLInputElement - поле ввода email.
-  private phoneInput: HTMLInputElement - поле ввода телефона.
-  private submitButton: HTMLButtonElement - кнопка отправки формы.
-  private errorsElement: HTMLElement - элемент для отображения ошибок формы.


Методы:
- protected setupElements(): void - находит и инициализирует элементы формы.
- protected setupListeners(): void - устанавливает обработчики событий для полей ввода и кнопки отправки формы.
- private handleInput(): void - обработчик ввода в поля email и телефона. Обновляет состояние кнопки отправки формы.
- private updateSubmitButtonState(): void - обновляет состояние кнопки отправки формы в зависимости от введенных email и телефона.
- protected emitEvent(): void - инициирует событие 'submit:order', передавая введенные email и телефон.
- render(template: HTMLTemplateElement): HTMLElement - возвращает готовый элемент формы.

#### Класс SuccessMessageView
Отображение сообщения об успешной оплате.
Конструктор класса принимает инстант брокера событий и (container: HTMLElement) для определения в нем нужных элементов.
На кнопку за новыми покупками уснанавливается слушатель клика инициирующий событие ('order:submited').

В полях класса хранятся следующие данные:
- events: IEvents - экземпляр, реализующий интерфейс IEvents, используемый для управления событиями страницы.
- totalPrice: HTMLParagraphElement - списанная сумма
- backToShopingButton: HTMLButtonElement - кнопка за новыми покупками

Методы:
- render(price: number): HTMLElement - возвращает готовый элемент.


### Презентер
Модели и отображение будут связываться с использованием событийно-ориентированного подхода, сам код презентера не будет выделен в отдельный класс, а будет размещен в основном скрипте приложения index.ts.
Далее описан сценарий работы приложения и применяемые события:

- При загрузке сайта:
-Создаются экземпляры классов: LarekApi, EventEmitter, CardsData, BasketModel, OrderDetails, PageView, ModalView.
-С сервера запрашивается список товаров и сохраняется в модель CardsData в следствии чего вызывается событие 'cards:updated' передавая массив карточек, на основании переданного массива создается массив элементов карточек товара (СatalogCardVeiw) и вставляется в список товаров внутри (PageView).

- Нажатие на карточку товара в каталоге (СatalogCardVeiw) вызывает событие 'product:selected' передавая данные товара. С использованием этих данных (CardPreviewVeiw) отрисовывает элемент предпросмотра товара и вставляется в мадалку (ModalView), после чего, модалка отображается на экране.

- Нажатие на кнопку добавления в корзину вызывает событие 'product:add' передавая данные товара. Данные сохраняются в модель корзины (BasketModel). Модальное окно закрывается.

- При вызове функций добавления товара, удаления товара и очистки корзины, вызывается событие 'basket:changed' передавая id соответствующего товара. Реакцией на это событие является: Соответствующее изменение в модели данных корзины (BasketModel), перерисовка отображения корзины (BasketView) и обнавление счетчика товаров в корзине на главной странице.

- Нажатие на корзину вызывает событие 'basket:open'. Используя данные и методы модели корзины отрисовывается элемент корзины (BasketView), отрисовываются элементы корзины (BasketItemView), вставляются в корзину, после чего, корзина вставляется в модалку и отображается на экране.

- Нажатие на кнопку удаления товара из корзины вызывает событие 'basket:changed' описанное выше.

- Нажатие на кнопку оформления заказа вызывает событие 'goto:payment'. В модель зказа (OrderDetails) сохраняется массив с айдишниками товаров и сумма заказа (эти данные берутся из модели корзины). Отрисовывается элемент выбора метода оплаты (PymentMethodView) и вставляется в модалку.

- Нажатие на кнопку далее вызывает событие 'goto:email' передавая способ оплаты и адрес. Эти данные сохраняются в модель зказа (OrderDetails). Отрисовывается элемент ввода почты и телефона (EmailVeiw) и вставляется в модалку.

- Нажатие на кнопку оплатить вызывает событие 'submit:order' передавая почту и телефон. Эти данные сохраняются в модель зказа (OrderDetails). После чего, заказ отравляется на сервер. Отрисовывается сообщения об успешной оплате (SuccessMessageView) и вставляется в модалку.

- Нажатие на кнопку за новыми покупками вызывает событие 'order:submited'. Корзина очищается. Модальное окно закрывается. Перерисовывается корзина. Обнавляется счетчик товаров в корзине на главной странице.